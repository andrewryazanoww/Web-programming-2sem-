# Web-programming-2sem-
# АИС "Учёт офисного оборудования"

## Описание проекта

Данное веб-приложение представляет собой Автоматизированную Информационную Систему (АИС) для учёта, обслуживания и списания офисного оборудования в организации. Приложение разработано с использованием фреймворка Flask на языке Python.

**Основные возможности системы:**

*   **Управление оборудованием:**
    *   Просмотр списка всего оборудования с возможностью фильтрации (по названию, категории, статусу, диапазону дат покупки) и сортировки.
    *   Пагинация для удобного просмотра больших списков.
    *   Просмотр детальной информации о каждой единице оборудования, включая фотографию, характеристики, ответственных лиц и историю обслуживания.
    *   Добавление нового оборудования (доступно Администратору).
    *   Редактирование существующего оборудования (доступно Администратору).
    *   Удаление оборудования с подтверждением через модальное окно (доступно Администратору). При удалении также удаляется связанный файл изображения и история обслуживания.
*   **Управление пользователями и ролями:**
    *   Система использует три роли: Администратор, Технический специалист, Пользователь.
    *   Аутентификация пользователей (вход/выход).
    *   Авторизация на основе ролей для доступа к различным функциям (реализована через декоратор и проверки в шаблонах).
*   **История обслуживания:**
    *   Просмотр истории обслуживания для каждой единицы оборудования.
    *   Добавление новых записей об обслуживании (доступно Администратору и Техническому специалисту), включая тип работ, описание, плановую и фактическую дату, статус ТО и исполнителя.
*   **Ответственные лица:**
    *   Возможность назначать одного ответственного пользователя (с ролью Администратор или Технический специалист) для каждой единицы оборудования.
*   **Календарь технического обслуживания (Индивидуальное задание):**
    *   Визуализация запланированных и выполненных работ по техническому обслуживанию в виде календаря (используется FullCalendar).
    *   Отображение списка ближайших плановых работ.
    *   Клик по событию в календаре открывает модальное окно с деталями.
*   **Загрузка изображений:**
    *   Для каждой единицы оборудования можно загрузить фотографию.
    *   Реализована проверка на дубликаты изображений по MD5-хэшу для экономии места.

## Технологический стек

*   **Язык:** Python 3
*   **Фреймворк:** Flask
*   **База данных:** SQLite (локальная, создается при первом запуске)
*   **ORM:** Flask-SQLAlchemy, SQLAlchemy
*   **Формы:** Flask-WTF, WTForms
*   **Аутентификация:** Flask-Login
*   **Шаблонизатор:** Jinja2
*   **Фронтенд:** Bootstrap 5 (для базовой стилизации и компонентов)
*   **Календарь:** FullCalendar (JavaScript библиотека)
*   **WSGI сервер (для деплоя):** Gunicorn

## Структура проекта

Проект организован с использованием паттерна Application Factory и Blueprint'ов для модульности:

*   `run.py`: Точка входа для запуска приложения локально.
*   `app/`: Основная папка приложения.
    *   `__init__.py`: Фабрика приложения `create_app()`, инициализация расширений, регистрация Blueprint'ов, создание таблиц БД и начальных данных.
    *   `config.py`: Файл конфигурации (путь к БД, секретный ключ и т.д.).
    *   `extensions.py`: Инициализация экземпляров расширений (SQLAlchemy, LoginManager).
    *   `models.py`: Определения моделей SQLAlchemy (User, Role, Equipment, Category, Image, ServiceHistory).
    *   `forms.py`: Определения WTForms (LoginForm, EquipmentForm, ServiceRecordForm).
    *   `tools.py`: Вспомогательные классы (ImageSaver, EquipmentFilter).
    *   `auth_bp.py`: Blueprint для аутентификации (вход, выход).
    *   `equipment_bp.py`: Blueprint для CRUD операций с оборудованием.
    *   `service_bp.py`: Blueprint для истории обслуживания и календаря ТО.
    *   `static/`: Статические файлы (CSS, JavaScript, изображения для интерфейса).
    *   `templates/`: HTML-шаблоны Jinja2.
    *   `media/equipment_images/`: Папка для загружаемых изображений оборудования (создается автоматически, если отсутствует).
*   `requirements.txt`: Список зависимостей Python.
*   `Procfile`: Инструкции для хостинга Render (запуск через Gunicorn).
*   `office_ais.db`: Файл базы данных SQLite (создается автоматически, добавлен в `.gitignore`).



При первом запуске (или после удаления `office_ais.db`) будут автоматически созданы таблицы базы данных и добавлены начальные данные (роли, категории, пользователи по умолчанию).

## Учетные данные пользователей по умолчанию

Для тестирования функционала системы создаются следующие пользователи:

*   **Администратор:**
    *   Логин: `admin`
    *   Пароль: `admin123`
*   **Технический специалист:**
    *   Логин: `tech`
    *   Пароль: `tech123`
*   **Пользователь:**
    *   Логин: `user`
    *   Пароль: `user123`

**Примечание:** Эти пароли предназначены только для демонстрации и тестирования.

## Деплой на Render

Приложение настроено для деплоя на платформу Render:
https://exam-ryazanov.onrender.com/

## Краткое описание кода по модулям

*   **`app/__init__.py` (Фабрика приложения):**
    *   Функция `create_app()` инициализирует приложение Flask, загружает конфигурацию.
    *   Инициализирует расширения (`db`, `login_manager`) с созданным экземпляром `app`.
    *   Регистрирует кастомный Jinja2 фильтр `nl2br`.
    *   Определяет обработчики ошибок (403, 404, 500, SQLAlchemyError).
    *   Регистрирует Blueprint'ы (`auth_bp`, `equipment_bp`, `service_bp`, `main_bp`).
    *   Создает `main_bp` для корневого URL и отдачи загруженных изображений.
    *   Определяет контекстный процессор `inject_current_time_and_permissions` для передачи `now` и функции проверки прав `can()` во все шаблоны.
    *   При создании приложения вызывает `db.create_all()` для создания таблиц и `initialize_database_content()` для заполнения начальными данными.

*   **`app/models.py`:**
    *   Определены все модели SQLAlchemy: `Role`, `User`, `Image`, `Category`, `Equipment`, `ServiceHistory`.
    *   Определена связующая таблица `equipment_responsible_persons` для отношения "многие-ко-многим" между `Equipment` и `User` (ответственные лица).
    *   В модели `User` реализованы методы `set_password`, `check_password`, свойство `full_name` и хелперы `is_admin`, `is_tech_specialist`.
    *   В модели `Image` есть свойства `storage_filename` и `url`.
    *   В модели `Equipment` настроены отношения с другими моделями, включая `lazy` загрузку и каскадные операции. Определено событие `after_delete` для удаления связанного файла изображения.
    *   В модели `ServiceHistory` добавлены поля `planned_date` и `status` для календаря ТО.

*   **`app/forms.py`:**
    *   `LoginForm`: Для аутентификации.
    *   `EquipmentForm`: Для создания и редактирования оборудования. Включает `SelectField` для категорий, `RadioField` для статусов, `FileField` для изображений и `SelectMultipleField` (рендерится как стандартный `<select multiple>`) для выбора ответственных лиц. `choices` для селектов заполняются в роутах.
    *   `ServiceRecordForm`: Для добавления/редактирования записей об обслуживании. Включает `DateField` для плановой и фактической даты, `SelectField` для статуса ТО и выбора исполнителя.

*   **`app/tools.py`:**
    *   `ImageSaver`: Класс для сохранения загружаемых изображений с проверкой на дубликаты по MD5-хэшу.
    *   `EquipmentFilter`: Класс для построения динамических запросов SQLAlchemy для фильтрации и сортировки списка оборудования.

*   **`app/auth_bp.py`:**
    *   Blueprint для аутентификации. Содержит роуты `/login` и `/logout`.

*   **`app/equipment_bp.py`:**
    *   Blueprint для управления оборудованием.
    *   Роут `/` (`index`): Отображает список оборудования с фильтрацией, сортировкой и пагинацией. Заполняет `choices` для формы фильтров.
    *   Роуты `/new` (GET) и `/create` (POST): Добавление нового оборудования. Заполняют `choices` для `category_id` и `responsible_person_ids` в `EquipmentForm`. Обрабатывают выбор ответственных лиц.
    *   Роут `/<id>` (`show`): Просмотр детальной информации. Использует жадную загрузку (joinedload, selectinload) для связанных данных. Передает `ServiceRecordForm` для добавления записей обслуживания.
    *   Роуты `/<id>/edit` (GET) и `/<id>/update` (POST): Редактирование оборудования. Предзаполняют форму, включая ответственных лиц. Обрабатывают смену изображения и обновление ответственных лиц.
    *   Роут `/<id>/delete` (POST): Удаление оборудования.
    *   Определен декоратор `role_required` для простой проверки ролей.

*   **`app/service_bp.py`:**
    *   Blueprint для функционала обслуживания.
    *   Роут `/equipment/<id>/add_record` (GET, POST): Добавление новой записи об обслуживании. Заполняет `choices` для `performed_by_id` в `ServiceRecordForm`.
    *   Роут `/` (`index`): Отображает календарь технического обслуживания. Загружает все записи `ServiceHistory` и передает их в шаблон `service/calendar.html` для инициализации FullCalendar.

*   **Шаблоны:**
    *   Используется наследование от `base.html`.
    *   Bootstrap 5 для стилизации.
    *   Кастомный `styles.css` для доработки дизайна.
    *   Макрос `pagination.html` для пагинации.
    *   Шаблон `_form.html` для общей части формы оборудования.
    *   Условное отображение элементов интерфейса на основе прав пользователя с помощью функции `can()`.
    *   Шаблон `calendar.html` использует JavaScript для инициализации FullCalendar и отображения событий.


