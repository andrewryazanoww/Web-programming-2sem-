{# app/templates/equipment/show.html #}
{% extends "base.html" %}
{% block title %}{{ title if title else equipment.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-4">
            {% if equipment.image %}
                <img src="{{ equipment.image.url }}" class="img-fluid rounded shadow-sm" alt="Фото: {{ equipment.name }}">
            {% else %}
                <div class="text-center p-5 border rounded bg-light mb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" class="bi bi-camera text-muted" viewBox="0 0 16 16">
                        <path d="M15 12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1h1.172a3 3 0 0 0 2.12-.879l.83-.828A1 1 0 0 1 6.827 3h2.344a1 1 0 0 1 .707.293l.828.828A3 3 0 0 0 12.828 5H14a1 1 0 0 1 1 1zM2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-1.172a2 2 0 0 1-1.414-.586l-.828-.828A2 2 0 0 0 9.172 2H6.828a2 2 0 0 0-1.414.586l-.828.828A2 2 0 0 1 3.172 4z"/>
                        <path d="M8 11a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5m0 1a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7M3 6.5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0"/>
                    </svg>
                    <p class="text-muted mt-2">Фотография отсутствует</p>
                </div>
            {% endif %}
        </div>
        <div class="col-md-8">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h1 class="mb-1">{{ equipment.name }}</h1>
                    <p class="text-muted mb-3">Инвентарный номер: <strong>{{ equipment.inventory_number }}</strong></p>
                </div>
                <div>
                    {% if current_user.is_authenticated and current_user.is_admin() %}
                        <a href="{{ url_for('equipment.edit', equipment_id=equipment.id) }}" class="btn btn-warning btn-sm">Редактировать</a>
                    {% endif %}
                </div>
            </div>

            <table class="table table-sm table-hover">
                <tbody>
                    <tr><th scope="row" style="width:30%;">Категория</th><td>{{ equipment.category.name if equipment.category else 'N/A' }}</td></tr>
                    <tr><th scope="row">Статус</th><td><span class="badge
                        {% if equipment.status == 'В эксплуатации' %}bg-success
                        {% elif equipment.status == 'На ремонте' %}bg-warning text-dark
                        {% elif equipment.status == 'Списано' %}bg-danger
                        {% else %}bg-secondary
                        {% endif %}">{{ equipment.status }}</span></td></tr>
                    <tr><th scope="row">Дата покупки</th><td>{{ equipment.purchase_date.strftime('%d.%m.%Y') if equipment.purchase_date else '-' }}</td></tr>
                    <tr><th scope="row">Стоимость</th><td>{{ "%.2f руб." | format(equipment.cost) }}</td></tr>
                    <tr><th scope="row">Примечание</th>
                        {# ИЗМЕНЕНИЕ ЗДЕСЬ: добавляем div с классом preserve-whitespace #}
                        <td><div class="preserve-whitespace">{{ equipment.notes if equipment.notes else '-' }}</div></td>
                    </tr>
                    <tr><th scope="row">Ответственные лица</th>
                        <td>
                            {% if equipment.responsible_persons.all() %}
                                {% for person in equipment.responsible_persons %}
                                    {{ person.full_name }}{% if not loop.last %}, {% endif %}
                                {% endfor %}
                            {% else %} <span class="text-muted">Не назначены</span> {% endif %}
                        </td>
                    </tr>
                     <tr><th scope="row">Дата добавления</th><td>{{ equipment.created_at.strftime('%d.%m.%Y %H:%M') }}</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <hr class="my-4">

    <div class="row mt-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>История обслуживания</h3>
                {% if service_form %} {# service_form передается только если есть права #}
                    <a href="{{ url_for('service.add_service_record', equipment_id=equipment.id) }}" class="btn btn-success btn-sm">
                        Добавить запись
                    </a>
                {% endif %}
            </div>
            {% if service_records %}
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>Дата</th>
                                <th>Тип работ</th>
                                <th>Описание</th>
                                <th>Исполнитель</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in service_records %} {# Предполагаем, что service_records уже отсортирован в view #}
                            <tr>
                                <td>{{ record.service_date.strftime('%d.%m.%Y %H:%M') }}</td>
                                <td>{{ record.service_type }}</td>
                                {# ИЗМЕНЕНИЕ ЗДЕСЬ: добавляем div с классом preserve-whitespace #}
                                <td><div class="preserve-whitespace">{{ record.description }}</div></td>
                                <td>{{ record.performed_by.full_name if record.performed_by else 'Не указан' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-muted">Записей об обслуживании для этого оборудования нет.</p>
            {% endif %}
        </div>
    </div>
    <div class="mt-4 mb-3"> {# Добавил mb-3 для отступа снизу #}
        <a href="{{ url_for('equipment.index') }}" class="btn btn-outline-secondary">К списку оборудования</a>
    </div>
</div>
{% endblock %}