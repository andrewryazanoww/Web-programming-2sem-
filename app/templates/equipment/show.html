{# app/templates/equipment/show.html #}
{% extends "base.html" %}
{# Если используете ServiceRecordForm, ее нужно передать из view #}
{# {% from "_form_helpers.html" import render_field %} - если есть такой макрос для форм #}

{% block title %}{{ title if title else "Просмотр оборудования" }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-4">
            {% if equipment.image and equipment.image.url %}
                <img src="{{ equipment.image.url }}" class="img-fluid rounded shadow-sm border" alt="{{ equipment.name }}" style="max-height: 300px; width: 100%; object-fit: contain;">
            {% else %}
                <div class="text-center p-5 border rounded bg-light d-flex align-items-center justify-content-center" style="height: 300px;">
                    <div>
                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" class="bi bi-camera text-muted" viewBox="0 0 16 16">
                            <path d="M15 12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1h1.172a3 3 0 0 0 2.12-.879l.83-.828A1 1 0 0 1 6.827 3h2.344a1 1 0 0 1 .707.293l.828.828A3 3 0 0 0 12.828 5H14a1 1 0 0 1 1 1zM2 4.5a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1M8 13A3.5 3.5 0 1 0 8 6a3.5 3.5 0 0 0 0 7M8 7a2.5 2.5 0 1 1 0 5 2.5 2.5 0 0 1 0-5"/>
                        </svg>
                        <p class="text-muted mt-2 mb-0">Фото отсутствует</p>
                    </div>
                </div>
            {% endif %}
        </div>
        <div class="col-md-8">
            <div class="d-flex justify-content-between align-items-center mb-2">
                 <h1 class="mb-0">{{ equipment.name }}</h1>
                 {% if can('edit_equipment', equipment.id) %}
                    <a href="{{ url_for('equipment.edit', equipment_id=equipment.id) }}" class="btn btn-warning btn-sm">
                        ✏️ Редактировать
                    </a>
                {% endif %}
            </div>
            <p class="lead text-muted mb-3">Инвентарный номер: <strong>{{ equipment.inventory_number }}</strong></p>
            <hr>
            <dl class="row">
                <dt class="col-sm-4">Категория:</dt>
                <dd class="col-sm-8">{{ equipment.category.name if equipment.category else 'Не указана' }}</dd>

                <dt class="col-sm-4">Статус:</dt>
                <dd class="col-sm-8">
                    {% if equipment.status == 'В эксплуатации' %}<span class="badge text-bg-success">{{ equipment.status }}</span>
                    {% elif equipment.status == 'На ремонте' %}<span class="badge text-bg-warning">{{ equipment.status }}</span>
                    {% elif equipment.status == 'Списано' %}<span class="badge text-bg-danger">{{ equipment.status }}</span>
                    {% else %}<span class="badge text-bg-secondary">{{ equipment.status }}</span>
                    {% endif %}
                </dd>

                <dt class="col-sm-4">Дата покупки:</dt>
                <dd class="col-sm-8">{{ equipment.purchase_date.strftime('%d.%m.%Y') if equipment.purchase_date else '-' }}</dd>

                <dt class="col-sm-4">Стоимость:</dt>
                <dd class="col-sm-8">{{ "%.2f руб." | format(equipment.cost) if equipment.cost is not none else '-' }}</dd>

                <dt class="col-sm-4">Дата добавления в систему:</dt>
                <dd class="col-sm-8">{{ equipment.created_at.strftime('%d.%m.%Y %H:%M') if equipment.created_at else '-' }}</dd>

                <dt class="col-sm-4">Примечание:</dt>
                <dd class="col-sm-8">{{ equipment.notes | nl2br if equipment.notes else '-' }}</dd>

                <dt class="col-sm-4">Ответственные лица:</dt>
                <dd class="col-sm-8">
                    {% if equipment.responsible_persons %}
                        {% for person in equipment.responsible_persons %}
                            {{ person.full_name }} ({{ person.login }}){% if not loop.last %};<br>{% endif %}
                        {% endfor %}
                    {% else %}
                        <span class="text-muted">Не назначены</span>
                    {% endif %}
                </dd>
            </dl>
            <div class="mt-3">
                <a href="{{ url_for('equipment.index') }}" class="btn btn-outline-secondary">Назад к списку</a>
            </div>
        </div>
    </div>

    <hr class="my-4">

    <div class="row mt-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2>История обслуживания</h2>
                {% if can('add_service_record', equipment.id) %}
                <a href="#addServiceRecordForm" class="btn btn-success btn-sm" data-bs-toggle="collapse" role="button" aria-expanded="false" aria-controls="addServiceRecordForm">
                    ➕ Добавить запись
                </a>
                {% endif %}
            </div>

            {# Форма добавления записи об обслуживании (скрыта по умолчанию) #}
            {% if service_form and can('add_service_record', equipment.id) %}
            <div class="collapse mb-4" id="addServiceRecordForm">
                <div class="card card-body">
                    <h4>Новая запись об обслуживании</h4>
                    <form method="POST" action="{{ url_for('service.add_service_record', equipment_id=equipment.id) }}" novalidate>
                        {{ service_form.hidden_tag() }}
                        <div class="mb-3">
                            {{ service_form.service_type.label(class="form-label") }}
                            {{ service_form.service_type(class="form-control" + (" is-invalid" if service_form.service_type.errors else ""), placeholder="Тип работ") }}
                            {% if service_form.service_type.description %}<div class="form-text">{{ service_form.service_type.description }}</div>{% endif %}
                            {% if service_form.service_type.errors %}<div class="invalid-feedback d-block">{% for error in service_form.service_type.errors %}{{ error }}<br>{% endfor %}</div>{% endif %}
                        </div>
                        <div class="mb-3">
                            {{ service_form.description.label(class="form-label") }}
                            {{ service_form.description(class="form-control" + (" is-invalid" if service_form.description.errors else ""), rows="3", placeholder="Описание...") }}
                            {% if service_form.description.errors %}<div class="invalid-feedback d-block">{% for error in service_form.description.errors %}{{ error }}<br>{% endfor %}</div>{% endif %}
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                {{ service_form.planned_date.label(class="form-label") }}
                                {{ service_form.planned_date(class="form-control" + (" is-invalid" if service_form.planned_date.errors else "")) }}
                                {% if service_form.planned_date.errors %}<div class="invalid-feedback d-block">{% for error in service_form.planned_date.errors %}{{ error }}<br>{% endfor %}</div>{% endif %}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ service_form.service_date.label(class="form-label") }}
                                {{ service_form.service_date(class="form-control" + (" is-invalid" if service_form.service_date.errors else "")) }}
                                {% if service_form.service_date.errors %}<div class="invalid-feedback d-block">{% for error in service_form.service_date.errors %}{{ error }}<br>{% endfor %}</div>{% endif %}
                            </div>
                             <div class="col-md-4 mb-3">
                                {{ service_form.status.label(class="form-label") }}
                                {{ service_form.status(class="form-select" + (" is-invalid" if service_form.status.errors else "")) }}
                                {% if service_form.status.errors %}<div class="invalid-feedback d-block">{% for error in service_form.status.errors %}{{ error }}<br>{% endfor %}</div>{% endif %}
                            </div>
                        </div>
                        <div class="mb-3">
                            {{ service_form.performed_by_id.label(class="form-label") }}
                            {{ service_form.performed_by_id(class="form-select" + (" is-invalid" if service_form.performed_by_id.errors else "")) }}
                            {% if service_form.performed_by_id.errors %}<div class="invalid-feedback d-block">{% for error in service_form.performed_by_id.errors %}{{ error }}<br>{% endfor %}</div>{% endif %}
                        </div>
                        {{ service_form.submit(class="btn btn-primary") }}
                    </form>
                </div>
            </div>
            {% endif %}


            {% if service_records %}
            <div class="table-responsive">
                <table class="table table-hover table-sm">
                    <thead class="table-light">
                        <tr>
                            <th>Плановая дата</th>
                            <th>Факт. дата</th>
                            <th>Тип</th>
                            <th>Описание</th>
                            <th>Статус</th>
                            <th>Исполнитель</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in service_records %}
                        <tr>
                            <td>{{ record.planned_date.strftime('%d.%m.%Y') if record.planned_date else '-' }}</td>
                            <td>{{ record.service_date.strftime('%d.%m.%Y %H:%M') if record.service_date else '-' }}</td>
                            <td>{{ record.service_type }}</td>
                            <td>{{ record.description | nl2br }}</td>
                            <td>
                                <span class="badge 
                                {% if record.status == 'Выполнено' %}bg-success
                                {% elif record.status == 'В процессе' %}bg-info text-dark
                                {% elif record.status == 'Запланировано' %}bg-primary
                                {% elif record.status == 'Отменено' %}bg-secondary
                                {% endif %}">{{ record.status }}</span>
                            </td>
                            <td>{{ record.performed_by.full_name if record.performed_by else 'Не указан' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted">Записей об обслуживании для данного оборудования пока нет.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}