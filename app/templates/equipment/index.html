{# app/templates/equipment/index.html #}
{% extends "base.html" %}
{% from "pagination.html" import render_pagination with context %}

{% block title %}{{ title if title else "–°–ø–∏—Å–æ–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è" }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>{{ title if title else "–°–ø–∏—Å–æ–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è" }}</h1>
        {# –ö–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ" —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤ #}
        {% if current_user.is_authenticated and current_user.is_admin() %}
            <a href="{{ url_for('equipment.new') }}" class="btn btn-primary">
                <i class="bi bi-plus-lg"></i> –î–æ–±–∞–≤–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
            </a>
        {% endif %}
    </div>

    {# TODO: –§–æ—Ä–º–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (–ø–æ–∑–∂–µ) #}
    {#
    <form method="GET" action="{{ url_for('equipment.index') }}" class="mb-4 p-3 border rounded bg-light">
        <div class="row g-3">
            <div class="col-md-4">
                <label for="filter_name" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input type="text" class="form-control form-control-sm" id="filter_name" name="name" value="{{ request.args.get('name', '') }}">
            </div>
            <div class="col-md-3">
                <label for="filter_category_id" class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                <select class="form-select form-select-sm" id="filter_category_id" name="category_id">
                    <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                    {% for category in categories %}
                        <option value="{{ category.id }}" {% if request.args.get('category_id')|int == category.id %}selected{% endif %}>{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="filter_status" class="form-label">–°—Ç–∞—Ç—É—Å</label>
                <select class="form-select form-select-sm" id="filter_status" name="status">
                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    {% for status_val in statuses %}
                        <option value="{{ status_val }}" {% if request.args.get('status') == status_val %}selected{% endif %}>{{ status_val }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-secondary btn-sm w-100">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</button>
            </div>
        </div>
    </form>
    #}

    {% if equipment_list %}
    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>#</th>
                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                    <th>–ò–Ω–≤. –Ω–æ–º–µ—Ä</th>
                    <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–î–∞—Ç–∞ –ø–æ–∫—É–ø–∫–∏</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for item in equipment_list %}
                <tr>
                    <td>{{ loop.index + pagination.first -1 if pagination else loop.index }}</td>
                    <td>
                        <a href="{{ url_for('equipment.show', equipment_id=item.id) }}">{{ item.name }}</a>
                    </td>
                    <td>{{ item.inventory_number }}</td>
                    <td>{{ item.category.name if item.category else 'N/A' }}</td>
                    <td>
                        {% if item.status == '–í —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏' %}
                            <span class="badge bg-success">{{ item.status }}</span>
                        {% elif item.status == '–ù–∞ —Ä–µ–º–æ–Ω—Ç–µ' %}
                            <span class="badge bg-warning text-dark">{{ item.status }}</span>
                        {% elif item.status == '–°–ø–∏—Å–∞–Ω–æ' %}
                            <span class="badge bg-danger">{{ item.status }}</span>
                        {% else %}
                            <span class="badge bg-secondary">{{ item.status }}</span>
                        {% endif %}
                    </td>
                    <td>{{ item.purchase_date.strftime('%d.%m.%Y') if item.purchase_date else '' }}</td>
                    <td>
                        <a href="{{ url_for('equipment.show', equipment_id=item.id) }}" class="btn btn-sm btn-outline-info me-1" title="–ü—Ä–æ—Å–º–æ—Ç—Ä">üëÅÔ∏è</a>
                        {% if current_user.is_authenticated and current_user.is_admin() %}
                            <a href="{{ url_for('equipment.edit', equipment_id=item.id) }}" class="btn btn-sm btn-outline-warning me-1" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</a>
                            <button type="button" class="btn btn-sm btn-outline-danger me-1" title="–£–¥–∞–ª–∏—Ç—å"
                                    data-bs-toggle="modal" data-bs-target="#deleteEquipmentModal"
                                    data-equipment-id="{{ item.id }}"
                                    data-equipment-name="{{ item.name }}">
                                üóëÔ∏è
                            </button>
                        {% endif %}
                        {% if current_user.is_authenticated and current_user.role and (current_user.is_admin() or current_user.is_tech_specialist()) %}
                            <a href="{{ url_for('service.add_service_record', equipment_id=item.id) }}" class="btn btn-sm btn-outline-success" title="–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –æ–± –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–∏">üõ†Ô∏è</a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% if pagination %}
        {{ render_pagination(pagination, 'equipment.index', params=request.args) }}
    {% endif %}
    {% else %}
    <div class="alert alert-info mt-3" role="alert">
        –°–ø–∏—Å–æ–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –ø—É—Å—Ç.
        {% if current_user.is_authenticated and current_user.is_admin() %}
            –í—ã –º–æ–∂–µ—Ç–µ <a href="{{ url_for('equipment.new') }}" class="alert-link">–¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</a>.
        {% endif %}
    </div>
    {% endif %}
</div>

{# –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è #}
<div class="modal fade" id="deleteEquipmentModal" tabindex="-1" aria-labelledby="deleteEquipmentModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteEquipmentModalLabel">–£–¥–∞–ª–µ–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ <strong id="deleteEquipmentNameModal"></strong>?
        <p class="text-danger mt-2"><small>–í–Ω–∏–º–∞–Ω–∏–µ: –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –æ–± –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–∏ –∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è!</small></p>
      </div>
      <div class="modal-footer">
        <form id="deleteEquipmentFormModal" method="POST" action="#"> {# action –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω JS #}
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ù–µ—Ç, –æ—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="btn btn-danger">–î–∞, —É–¥–∞–ª–∏—Ç—å</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // JS –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
    const deleteModalElement = document.getElementById('deleteEquipmentModal');
    if (deleteModalElement) {
        deleteModalElement.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const equipmentId = button.getAttribute('data-equipment-id');
            const equipmentName = button.getAttribute('data-equipment-name');
            
            const modalNameElement = deleteModalElement.querySelector('#deleteEquipmentNameModal');
            const deleteForm = deleteModalElement.querySelector('#deleteEquipmentFormModal');

            if (modalNameElement) modalNameElement.textContent = equipmentName;
            // –í–∞–∂–Ω–æ: –∏—Å–ø–æ–ª—å–∑—É–µ–º url_for, –µ—Å–ª–∏ —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ (–Ω—É–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å –µ–≥–æ –≤ JS)
            // –∏–ª–∏ —Ñ–æ—Ä–º–∏—Ä—É–µ–º URL –≤—Ä—É—á–Ω—É—é, –∫–∞–∫ –∑–¥–µ—Å—å.
            if (deleteForm) deleteForm.action = `/equipment/${equipmentId}/delete`;
        });
    }
</script>
{% endblock %}