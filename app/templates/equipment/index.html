{# app/templates/equipment/index.html #}
{% extends "base.html" %}
{% from "pagination.html" import render_pagination with context %}

{% block title %}{{ title if title else "–°–ø–∏—Å–æ–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è" }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
        <h1 class="mb-2 mb-md-0">{{ title if title else "–°–ø–∏—Å–æ–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è" }}</h1>
        {% if can('create_equipment') %}
            <a href="{{ url_for('equipment.new') }}" class="btn btn-primary">
                ‚ûï –î–æ–±–∞–≤–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
            </a>
        {% endif %}
    </div>

    <form method="GET" action="{{ url_for('equipment.index') }}" class="mb-4 p-3 border rounded bg-light shadow-sm">
        <h5 class="mb-3">–§–∏–ª—å—Ç—Ä—ã</h5>
        <div class="row g-3">
            <div class="col-md-3">
                <label for="name_filter" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input type="text" name="name_filter" id="name_filter" class="form-control form-control-sm" value="{{ current_filters.name_filter or '' }}">
            </div>
            <div class="col-md-3">
                <label for="category_id_filter" class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                <select name="category_id" id="category_id_filter" class="form-select form-select-sm">
                    <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                    {% for category in categories %}
                        <option value="{{ category.id }}" {% if current_filters.category_id|int == category.id %}selected{% endif %}>
                            {{ category.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="status_filter" class="form-label">–°—Ç–∞—Ç—É—Å</label>
                <select name="status" id="status_filter" class="form-select form-select-sm">
                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    {% for status_val in statuses %}
                        <option value="{{ status_val }}" {% if current_filters.status == status_val %}selected{% endif %}>
                            {{ status_val }}
                        </option>
                    {% endfor %}
                </select>
            </div>
             <div class="col-md-3">
                {# –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ - –º–æ–∂–Ω–æ –±—É–¥–µ—Ç —É–ª—É—á—à–∏—Ç—å –≤ –±—É–¥—É—â–µ–º #}
                <label for="sort_by_filter" class="form-label">–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ</label>
                <select name="sort_by" id="sort_by_filter" class="form-select form-select-sm">
                    <option value="purchase_date" {% if current_filters.sort_by == 'purchase_date' %}selected{% endif %}>–î–∞—Ç–µ –ø–æ–∫—É–ø–∫–∏</option>
                    <option value="name" {% if current_filters.sort_by == 'name' %}selected{% endif %}>–ù–∞–∑–≤–∞–Ω–∏—é</option>
                    <option value="category_name" {% if current_filters.sort_by == 'category_name' %}selected{% endif %}>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                    <option value="status" {% if current_filters.sort_by == 'status' %}selected{% endif %}>–°—Ç–∞—Ç—É—Å—É</option>
                </select>
                 <select name="sort_direction" class="form-select form-select-sm mt-1">
                    <option value="desc" {% if current_filters.sort_direction == 'desc' %}selected{% endif %}>–ü–æ —É–±—ã–≤–∞–Ω–∏—é</option>
                    <option value="asc" {% if current_filters.sort_direction == 'asc' %}selected{% endif %}>–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
                </select>
            </div>
        </div>
        <div class="row g-3 mt-1">
            <div class="col-md-3">
                <label for="purchase_date_from_filter" class="form-label">–î–∞—Ç–∞ –ø–æ–∫—É–ø–∫–∏ –æ—Ç:</label>
                <input type="date" name="purchase_date_from" id="purchase_date_from_filter" class="form-control form-control-sm" value="{{ current_filters.purchase_date_from or '' }}">
            </div>
            <div class="col-md-3">
                <label for="purchase_date_to_filter" class="form-label">–î–∞—Ç–∞ –ø–æ–∫—É–ø–∫–∏ –¥–æ:</label>
                <input type="date" name="purchase_date_to" id="purchase_date_to_filter" class="form-control form-control-sm" value="{{ current_filters.purchase_date_to or '' }}">
            </div>
             <div class="col-md-3 align-self-end">
                <button type="submit" class="btn btn-info btn-sm w-100">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            </div>
            <div class="col-md-3 align-self-end">
                <a href="{{ url_for('equipment.index') }}" class="btn btn-outline-secondary btn-sm w-100">–°–±—Ä–æ—Å–∏—Ç—å</a>
            </div>
        </div>
    </form>

    {% if equipment_list %}
    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>#</th>
                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                    <th>–ò–Ω–≤. –Ω–æ–º–µ—Ä</th>
                    <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–î–∞—Ç–∞ –ø–æ–∫—É–ø–∫–∏</th>
                    <th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for item in equipment_list %}
                <tr>
                    <td>{{ loop.index + pagination.first -1 if pagination and pagination.first else loop.index }}</td>
                    <td><a href="{{ url_for('equipment.show', equipment_id=item.id) }}">{{ item.name }}</a></td>
                    <td>{{ item.inventory_number }}</td>
                    <td>{{ item.category.name if item.category else 'N/A' }}</td>
                    <td>
                        {% if item.status == '–í —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏' %}<span class="badge text-bg-success">{{ item.status }}</span>
                        {% elif item.status == '–ù–∞ —Ä–µ–º–æ–Ω—Ç–µ' %}<span class="badge text-bg-warning">{{ item.status }}</span>
                        {% elif item.status == '–°–ø–∏—Å–∞–Ω–æ' %}<span class="badge text-bg-danger">{{ item.status }}</span>
                        {% else %}<span class="badge text-bg-secondary">{{ item.status }}</span>
                        {% endif %}
                    </td>
                    <td>{{ item.purchase_date.strftime('%d.%m.%Y') if item.purchase_date else '' }}</td>
                    <td>
                        {% if item.responsible_persons %}
                            {% for person in item.responsible_persons %}
                                <small>{{ person.full_name }}{% if not loop.last %},<br>{% endif %}</small>
                            {% endfor %}
                        {% else %}
                            <small class="text-muted">-</small>
                        {% endif %}
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            {% if can('view_equipment_detail', item.id) %}
                                <a href="{{ url_for('equipment.show', equipment_id=item.id) }}" class="btn btn-outline-info" title="–ü—Ä–æ—Å–º–æ—Ç—Ä">üëÅÔ∏è</a>
                            {% endif %}
                            {% if can('edit_equipment', item.id) %}
                                <a href="{{ url_for('equipment.edit', equipment_id=item.id) }}" class="btn btn-outline-warning" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</a>
                            {% endif %}
                            {% if can('delete_equipment', item.id) %}
                                <button type="button" class="btn btn-outline-danger" title="–£–¥–∞–ª–∏—Ç—å"
                                        data-bs-toggle="modal" data-bs-target="#deleteEquipmentModal"
                                        data-equipment-id="{{ item.id }}"
                                        data-equipment-name="{{ item.name }}">
                                    üóëÔ∏è
                                </button>
                            {% endif %}
                            {% if can('add_service_record', item.id) %}
                                <a href="{{ url_for('service.add_service_record', equipment_id=item.id) }}" class="btn btn-outline-success" title="–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ">üõ†Ô∏è</a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% if pagination %}
        {{ render_pagination(pagination, 'equipment.index', params=request.args) }}
    {% endif %}
    {% else %}
    <div class="alert alert-info mt-3" role="alert">
        –°–ø–∏—Å–æ–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –ø—É—Å—Ç.
        {% if can('create_equipment') %}
            –í—ã –º–æ–∂–µ—Ç–µ <a href="{{ url_for('equipment.new') }}" class="alert-link">–¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</a>.
        {% endif %}
    </div>
    {% endif %}
</div>

<div class="modal fade" id="deleteEquipmentModal" tabindex="-1" aria-labelledby="deleteEquipmentModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteEquipmentModalLabel">–£–¥–∞–ª–µ–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ <strong id="deleteEquipmentNameModal"></strong>?
        <p class="text-danger mt-2"><small>–í–Ω–∏–º–∞–Ω–∏–µ: –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –æ–± –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–∏ –∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è!</small></p>
      </div>
      <div class="modal-footer">
        <form id="deleteEquipmentFormModal" method="POST" action="#">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ù–µ—Ç, –æ—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="btn btn-danger">–î–∞, —É–¥–∞–ª–∏—Ç—å</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
    const deleteModalElement = document.getElementById('deleteEquipmentModal');
    if (deleteModalElement) {
        deleteModalElement.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const equipmentId = button.getAttribute('data-equipment-id');
            const equipmentName = button.getAttribute('data-equipment-name');
            const modalNameElement = deleteModalElement.querySelector('#deleteEquipmentNameModal');
            const deleteForm = deleteModalElement.querySelector('#deleteEquipmentFormModal');
            if (modalNameElement) modalNameElement.textContent = equipmentName;
            if (deleteForm) deleteForm.action = `{{ url_for('equipment.index') }}${equipmentId}/delete`;
        });
    }
</script>
{% endblock %}